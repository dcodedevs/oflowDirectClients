<?php

// error_reporting(E_ALL);
// ini_set("display_errors", 1);
	ini_set('max_execution_time', 120);

	if(isset($_POST['listCases'])) {
		$invoice_nrs = array(
			517242,
			511504,
			516176,
			506739,
			512188,
			523861,
			399432,
			423829,
			412022,
			399432,
			397531,
			388774,
			419254,
			409377,
			516386,
			518432,
			514842,
			479504,
			524410,
			504923,
			521051,
			515758,
			514629,
			489253,
			522229,
			523474,
			515820,
			517012,
			509624,
			525521,
			516205,
			518746,
			526191,
			518042,
			524662,
			526201,
			522560,
			502720,
			522944,
			526284,
			523208,
			525613,
			516787,
			491332,
			522899,
			517386,
			522648,
			525771,
			491420,
			509236,
			520644,
			522174,
			518530,
			526336,
			518373,
			525713,
			519407,
			514924,
			518295,
			501400,
			468008,
			468008,
			490614,
			505040,
			489059,
			522715,
			488017,
			520309,
			524952,
			524690,
			523621,
			526383,
			524479,
			523586,
			516370,
			525952,
			498781,
			525090,
			516107,
			524481,
			522369,
			516099,
			520778,
			516053,
			525538,
			522646,
			520746,
			521775,
			518814,
			526769,
			518591,
			525084,
			520347,
			519409,
			515169,
			522702,
			520918,
			520918,
			516019,
			519004,
			516008,
			485619,
			517908,
			525651,
			520909,
			522446,
			526571,
			523213,
			511025,
			522994,
			515554,
			524866,
			521305,
			488357,
			515731,
			521219,
			521931,
			515715,
			516783,
			520419,
			524898,
			526141,
			519381,
			516919,
			526172,
			520900,
			516974,
			517670,
			525832,
			520988,
			519559,
			516361,
			516675,
			481540,
			517633,
			516393,
			524841,
			518469,
			518469,
			516988,
			523356,
			484203,
			518293,
			522210,
			515315,
			522685,
			500177,
			518897,
			527160,
			503944,
			526989,
			520214,
			524636,
			515593,
			519817,
			523084,
			521013,
			491137,
			491137,
			491137,
			502137,
			502137,
			523838,
			517417,
			524648,
			516459,
			520691,
			516087,
			519490,
			527018,
			517490,
			517293,
			524391,
			520436,
			526817,
			524633,
			508184,
			524435,
			523865,
			518440,
			526263,
			524894,
			515303,
			524666,
			525581,
			519532,
			517632,
			463029,
			524458,
			517618,
			477056,
			518114,
			515054,
			518775,
			517884,
			525808,
			521005,
			521399,
			520880,
			522129,
			369920,
			524730,
			524926,
			518779,
			517092,
			519919,
			523548,
			521841,
			516443,
			288362,
			502250,
			521610,
			520167,
			524096,
			515757,
			517382,
			518082,
			518298,
			519763,
			519485,
			524793,
			526363,
			504218,
			526463,
			526800,
			518666,
			524859,
			519274,
			519146,
			331350,
			334865,
			361229,
			372401,
			523593,
			526468,
			526461,
			527104,
			526665,
			517071,
			514994,
			519455,
			524973,
			516832,
			523206,
			518667,
			519860,
			524449,
			523750,
			521883,
			519127,
			517726,
			525920,
			525441,
			519267,
			527078,
			525470,
			525406,
			518706,
			524508,
			471221,
			471221,
			471485,
			521547,
			492231,
			523540,
			524781,
			471485,
			490607,
			521898,
			524939,
			480996,
			480995,
			526380,
			525452,
			524400,
			516012,
			482785,
			518178,
			521784,
			524712,
			524653,
			519036,
			515423,
			519145,
			525971,
			516449,
			519718,
			484573,
			525853,
			519789,
			521258,
			523050,
			525732,
			519877,
			519826,
			522942,
			483176,
			522199,
			517327,
			481854,
			523185,
			525834,
			520377,
			515774,
			523126,
			522247,
			522724,
			518001,
			524112,
			463930,
			477817,
			483473,
			522135,
			524760,
			520439,
			521310,
			425684,
			431557,
			444334,
			464651,
			468931,
			497870,
			512054,
			525629,
			509282,
			519400,
			517477,
			512198,
			509958,
			523633,
			511871,
			491309,
			524581,
			506771,
			520246,
			515376,
			526433,
			523049,
			525904,
			522201,
			518832,
			521592,
			518550,
			525783,
			489528,
			522338,
			517146,
			523423,
			493621,
			515503,
			522779,
			527162,
			525051,
			504494,
			522499,
			522759,
			519094,
			516729,
			491371,
			504298,
			519453,
			489516,
			519105,
			497313,
			520792,
			520127,
			519100,
			517977,
			516471,
			526173,
			521885,
			524230,
			523993,
			526888,
			523981,
			516246,
			521818,
			515633,
			525988,
			526620,
			519536,
			518119,
			526556,
			482899,
			523404,
			521515,
			463029,
			525489,
			501002,
			524312,
			526519,
			523029,
			488741,
			520766,
			520429,
			491819,
			520505,
			471832,
			491160,
			516211,
			523788,
			506964,
			502732,
			525140,
			507891,
			524677,
			525784,
			524238,
			482722,
			519338,
			519253,
			523015,
			515712,
			515627,
			518855,
			514318,
			524282,
			522923,
			527271,
			519464,
			509846,
			516333,
			484407,
			512886,
			515787,
			519969,
			525751,
			499145,
			520187,
			526812,
			518452,
			523598,
			523513,
			516900,
			519970,
			471471,
			509360,
			517266,
			526260,
			525753,
			517440,
			520899,
			504766,
			520581,
			521202,
			523483,
			511419,
			487514,
			515185,
			522673);
		$s_sql = "SELECT * FROM creditor_transactions WHERE invoice_nr IN (".implode(",", $invoice_nrs).") AND collectingcase_id > 0 AND creditor_id = 1031";
		$o_query = $o_main->db->query($s_sql);
		$invoices = ($o_query ? $o_query->result_array() : array());
		foreach($invoices as $invoice){
			$s_edit_link = $_SERVER['PHP_SELF']."?pageID=".$_GET['pageID']."&accountname=".$_GET['accountname']."&companyID=".$_GET['companyID']."&caID=".$_GET['caID']."&module=CollectingCases&folderfile=output&folder=output&inc_obj=details&cid=".$invoice['collectingcase_id'];
			$hasPaymentOn19 = false;
			$s_sql = "SELECT * FROM creditor_transactions  WHERE (system_type='Payment' OR system_type ='CreditnoteCustomer') AND link_id = ? AND creditor_id = ? AND date = '2023-06-19'";
			$o_query = $o_main->db->query($s_sql, array($invoice['link_id'], $invoice['creditor_id']));
			$payment = ($o_query ? $o_query->row_array() : array());
			if($payment){
				$hasPaymentOn19 = true;
			}
			$connected_transactions = array();
			$s_sql = "SELECT * FROM creditor_transactions ct WHERE ct.link_id = ? AND (ct.open = 1) AND (ct.system_type='InvoiceCustomer' OR ct.system_type = 'CreditnoteCustomer') AND ct.id <> ? AND ct.date >= '2023-06-19'";
			$o_query = $o_main->db->query($s_sql, array($invoice['link_id'], $invoice['id']));
			$connected_transactions_raw = ($o_query ? $o_query->result_array() : array());	
			foreach($connected_transactions_raw as $connected_transaction_raw){
				if(strpos($connected_transaction_raw['comment'], '_') !== false){
					$connected_transactions[] = $connected_transaction_raw;
				}
			}
		?>
		<a href="<?php echo $s_edit_link;?>" target="_blank">
			<?php echo $formText_CaseId_output.": ". $invoice['collectingcase_id']?> - <?php echo $invoice['invoice_nr'];?>
			<?php if($invoice['open'] == 0) echo " - ".$formText_Closed_output;
			if($hasPaymentOn19){
				echo " - ".$formText_HasPaymentOn19_output;
			}
			?>
		</a>
		<?php 			
			if(count($connected_transactions)> 0){
				echo " - <span class='redColored'>".$formText_HasFeesAfter19_output."</span>";
			}
		?><br/>
		<?php }

	}
?>
<div>
	<form name="importData" method="post" enctype="multipart/form-data"  action="">
		<div class="formRow submitRow">
			<input type="submit" name="listCases" value="List cases">
		</div>
	</form>
</div>
<style>
	.redColored {
		color: red;
	}
</style>
